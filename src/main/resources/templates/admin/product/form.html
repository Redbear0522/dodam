<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 등록</title>
    <!-- 기존 CSS 유지 -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛍️ 상품 등록</h1>
            <p>새로운 상품을 등록하고 관리하세요</p>
        </div>

        <div class="form-container">
            <form id="productForm" th:action="${product.pronum == null} ? '/admin/products/add' : '/admin/products/edit/' + ${product.pronum}" th:object="${product}" method="post">
                <div class="form-grid">
                    <!-- 기본 정보 섹션 -->
                    <div class="section-title">기본 정보</div>
                    
                    <div class="form-group">
                        <label for="categoryId">카테고리 <span class="required">*</span></label>
                        <select id="categoryId" name="categoryId" required>
                            <option value="">카테고리를 선택하세요</option>
                            <option th:each="category : ${categories}" th:value="${category.catenum}" th:selected="${category.catenum == product.category?.catenum}" th:text="${category.catename}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="creatorMemberId">등록자 ID <span class="required">*</span></label>
                        <input type="text" id="creatorMemberId" name="procreat" th:value="${product.procreat ?: ''}" required readonly>
                    </div>

                    <div class="form-group full-width">
                        <label for="name">상품명 <span class="required">*</span></label>
                        <input type="text" id="name" name="proname" maxlength="200" th:value="${product.proname ?: ''}" required placeholder="상품명을 입력하세요">
                    </div>

                    <div class="form-group full-width">
                        <label for="description">상품 설명</label>
                        <textarea id="description" name="prodetai1" th:text="${product.prodetai1 ?: ''}" placeholder="상품에 대한 상세한 설명을 입력하세요"></textarea>
                    </div>

                    <!-- 가격 정보 섹션 -->
                    <div class="section-title">가격 정보</div>

                    <div class="form-group">
                        <label for="listPrice">정가 <span class="required">*</span></label>
                        <input type="number" id="listPrice" name="proprice" min="0" step="100" th:value="${product.proprice ?: ''}" required placeholder="0">
                    </div>

                    <div class="form-group">
                        <label for="grade">상품등급</label>
                        <select id="grade" name="prograd">
                            <option value="">선택하세요</option>
                            <option value="S" th:selected="${product.prograd == 'S'}">S급 (최상)</option>
                            <option value="A" th:selected="${product.prograd == 'A'}">A급 (상)</option>
                            <option value="B" th:selected="${product.prograd == 'B'}">B급 (중)</option>
                            <option value="C" th:selected="${product.prograd == 'C'}">C급 (하)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rentPrice">대여가격 <span class="required">*</span></label>
                        <input type="number" id="rentPrice" name="prorent" min="0" step="100" th:value="${product.prorent ?: ''}" required placeholder="0" readonly>
                    </div>

                    <!-- 상품 상세 정보 섹션 -->
                    <div class="section-title">상품 상세 정보</div>

                    <div class="form-group">
                        <label for="brand">브랜드</label>
                        <input type="text" id="brand" name="probrand" maxlength="100" th:value="${product.probrand ?: ''}" placeholder="브랜드명 입력">
                    </div>

                    <div class="form-group">
                        <label for="manufacturer">제조사</label>
                        <input type="text" id="manufacturer" name="promanuf" maxlength="100" th:value="${product.promanuf ?: ''}" placeholder="제조사명 입력">
                    </div>

                    <div class="form-group">
                        <label for="safetyCert">안전인증</label>
                        <input type="text" id="safetyCert" name="prosafe" maxlength="100" th:value="${product.prosafe ?: ''}" placeholder="KC인증 등">
                    </div>

                    <!-- 추천 연령 섹션 -->
                    <div class="section-title">추천 연령</div>

                    <div class="form-group">
                        <label for="recommendedAgeFrom">최소 연령</label>
                        <input type="number" id="recommendedAgeFrom" name="proagfr" min="0" max="100" th:value="${product.proagfr ?: ''}" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label for="recommendedAgeTo">최대 연령</label>
                        <input type="number" id="recommendedAgeTo" name="proagto" min="0" max="100" th:value="${product.proagto ?: ''}" placeholder="99">
                    </div>

                    <div class="form-group">
                        <label for="minRentalDays">최소 대여일</label>
                        <input type="number" id="minRentalDays" name="promind" min="1" th:value="${product.promind ?: '1'}" placeholder="1" value="1">
                    </div>

                    <div class="form-group">
                        <label for="status">상품 상태</label>
                        <select id="status" name="prostat">
                            <option value="AVAILABLE" th:selected="${product.prostat == 'AVAILABLE'}">대여가능</option>
                            <option value="RENTED" th:selected="${product.prostat == 'RENTED'}">대여중</option>
                            <option value="MAINTENANCE" th:selected="${product.prostat == 'MAINTENANCE'}">대기중</option>
                            <option value="DISCONTINUED" th:selected="${product.prostat == 'DISCONTINUED'}">대여불가</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <div class="checkbox-group">
                            <input type="checkbox" id="isPublic" name="proispu" th:checked="${product.proispu}">
                            <label for="isPublic">공개 여부</label>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="resetForm()">초기화</button>
                    <button type="submit" class="btn-primary">상품 등록</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast">
        ✅ 상품이 성공적으로 등록되었습니다!
    </div>

	<script>
	    // 쿠키 읽기 함수
	    function getCookie(name) {
	        const value = `; ${document.cookie}`;
	        const parts = value.split(`; ${name}=`);
	        if (parts.length === 2) return parts.pop().split(';').shift();
	        return null;
	    }

	    // 페이지 로드 시 등록자 ID 자동 설정
	    window.addEventListener('load', function() {
	        const username = getCookie('username');
	        if (username) {
	            document.getElementById('creatorMemberId').value = username;
	        } else {
	            console.warn('등록자 ID 쿠키가 없습니다.');
	        }
	        updateRentPrice();
	    });

	    // 대여가격 자동 계산 함수
	    function updateRentPrice() {
	        const listPrice = parseInt(document.getElementById('listPrice').value) || 0;
	        const grade = document.getElementById('grade').value;
	        let ratio = 0;

	        switch (grade) {
	            case 'S': ratio = 1.00; break;
	            case 'A': ratio = 0.90; break;
	            case 'B': ratio = 0.80; break;
	            case 'C': ratio = 0.70; break;
	            default: ratio = 0;
	        }

	        const rentPrice = Math.floor(listPrice * ratio);
	        document.getElementById('rentPrice').value = rentPrice;
	    }

	    // 정가와 상품등급 변경 시 대여가격 업데이트
	    document.getElementById('listPrice').addEventListener('input', updateRentPrice);
	    document.getElementById('grade').addEventListener('change', updateRentPrice);

	    // 폼 제출 처리
	    document.getElementById('productForm').addEventListener('submit', function(e) {
	        e.preventDefault(); // 임시로 복구, 네트워크 요청 확인 후 제거
	        const formData = new FormData(this);
	        const data = {};
	        for (let [key, value] of formData.entries()) {
	            if (value !== '') data[key] = value;
	        }
	        data.proispu = document.getElementById('isPublic').checked;
	        console.log('제출 데이터:', data);

	        // AJAX로 서버 전송 (디버깅용)
	        fetch(this.action, {
	            method: 'POST',
	            body: new URLSearchParams(data).toString(),
	            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
	        })
	        .then(response => response.json())
	        .then(result => {
	            console.log('서버 응답:', result);
	            showToast();
	        })
	        .catch(error => console.error('오류:', error));
	    });

	    // 폼 초기화 함수
	    function resetForm() {
	        if (confirm('모든 입력 내용을 초기화하시겠습니까?')) {
	            document.getElementById('productForm').reset();
	            updateRentPrice();
	        }
	    }

	    // 토스트 메시지 표시
	    function showToast() {
	        const toast = document.getElementById('toast');
	        toast.classList.add('show');
	        setTimeout(() => toast.classList.remove('show'), 3000);
	    }
	</script>
</body>
</html>